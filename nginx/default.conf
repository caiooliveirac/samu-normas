# Arquivo incluído no contexto http de Nginx (conf.d/*.conf)

# ==============================
# BLOCO HTTP (contexto global)
# ==============================

# Cloudflare -> Nginx: usar IP real do cliente enviado no header oficial.
real_ip_header CF-Connecting-IP;
real_ip_recursive on;

# Ranges oficiais Cloudflare (IPv4 + IPv6)
set_real_ip_from 173.245.48.0/20;
set_real_ip_from 103.21.244.0/22;
set_real_ip_from 103.22.200.0/22;
set_real_ip_from 103.31.4.0/22;
set_real_ip_from 141.101.64.0/18;
set_real_ip_from 108.162.192.0/18;
set_real_ip_from 190.93.240.0/20;
set_real_ip_from 188.114.96.0/20;
set_real_ip_from 197.234.240.0/22;
set_real_ip_from 198.41.128.0/17;
set_real_ip_from 162.158.0.0/15;
set_real_ip_from 104.16.0.0/13;
set_real_ip_from 104.24.0.0/14;
set_real_ip_from 172.64.0.0/13;
set_real_ip_from 131.0.72.0/22;
set_real_ip_from 2400:cb00::/32;
set_real_ip_from 2606:4700::/32;
set_real_ip_from 2803:f800::/32;
set_real_ip_from 2405:b500::/32;
set_real_ip_from 2405:8100::/32;
set_real_ip_from 2a06:98c0::/29;
set_real_ip_from 2c0f:f248::/32;

# Marca se a conexão chegou de um IP de borda Cloudflare.
# Usa $realip_remote_addr (IP original do peer) para não confundir com o
# cliente final após real_ip_header CF-Connecting-IP.
geo $realip_remote_addr $from_cloudflare {
    default 0;
    173.245.48.0/20 1;
    103.21.244.0/22 1;
    103.22.200.0/22 1;
    103.31.4.0/22 1;
    141.101.64.0/18 1;
    108.162.192.0/18 1;
    190.93.240.0/20 1;
    188.114.96.0/20 1;
    197.234.240.0/22 1;
    198.41.128.0/17 1;
    162.158.0.0/15 1;
    104.16.0.0/13 1;
    104.24.0.0/14 1;
    172.64.0.0/13 1;
    131.0.72.0/22 1;
    2400:cb00::/32 1;
    2606:4700::/32 1;
    2803:f800::/32 1;
    2405:b500::/32 1;
    2405:8100::/32 1;
    2a06:98c0::/29 1;
    2c0f:f248::/32 1;
}

## Bloqueio de tráfego não-Cloudflare
##
## ATENÇÃO:
## - Esta aplicação já é protegida no nível de rede (AWS Security Group) via prefix list do Cloudflare.
## - Manter uma lista hardcoded de ranges do Cloudflare aqui pode ficar desatualizado e causar
##   falhas intermitentes (ex.: links abrindo “e piscando” no WhatsApp para alguns usuários).
## - Por isso, o bloqueio no nginx fica DESABILITADO por padrão.
##
## Se um dia precisar reativar a restrição no nginx, volte este map para default=1 e mantenha
## a lista de IPs sempre atualizada.
map "$from_cloudflare:$request_uri" $deny_non_cf {
    default 0;
}

# Preserva X-Forwarded-Proto de forma segura (fallback para $scheme).
map $http_x_forwarded_proto $proxy_x_forwarded_proto {
    default $scheme;
    ~*^https$ https;
    ~*^http$  http;
}

# Upstreams com keepalive para reduzir custo de conexão TCP por requisição.
upstream app_web {
    server web:8000;
    keepalive 64;
}

upstream app_financas {
    server swiss-track-finance:8080;
    keepalive 32;
}

upstream app_frases {
    server frases_web:8000;
    keepalive 32;
}

upstream app_tutoriais {
    server tutoriais:3000;
    keepalive 32;
}

upstream app_treinos_frontend {
    server treinododia-frontend:3000;
    keepalive 32;
}

upstream app_treinos_backend {
    server treinododia-backend:3333;
    keepalive 32;
}

upstream app_forca_frontend {
    server forca-frontend:80;
    keepalive 32;
}

upstream app_forca_backend {
    server forca-backend:3001;
    keepalive 32;
}

upstream app_maps_nginx {
    server maps-nginx:80;
    keepalive 32;
}

# ======================
# BLOCO SERVER - HTTP 80
# ======================
server {
    listen 80;
    server_name mnrs.com.br www.mnrs.com.br _;

    location = /nginx-health {
        access_log off;
        add_header Content-Type text/plain;
        return 200 'ok';
    }

    # Força HTTPS para todo tráfego válido via Cloudflare.
    location / {
        return 301 https://$host$request_uri;
    }
}

# =======================
# BLOCO SERVER - HTTPS 443
# =======================
server {
    listen 443 ssl;
    http2 on;
    server_name mnrs.com.br www.mnrs.com.br;

    # Certificado Origin da Cloudflare
    ssl_certificate     /etc/nginx/ssl/cloudflare-origin.crt;
    ssl_certificate_key /etc/nginx/ssl/cloudflare-origin.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_session_cache shared:SSL:20m;
    ssl_session_timeout 1d;
    ssl_session_tickets off;

    # Security headers recomendados
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    # Opcional (habilite após validar assets/scripts):
    # add_header Content-Security-Policy "default-src 'self'; img-src 'self' data: https:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https:; style-src 'self' 'unsafe-inline' https:; connect-src 'self' https:; frame-ancestors 'self'; base-uri 'self'; form-action 'self' https:; upgrade-insecure-requests" always;

    resolver 127.0.0.11 ipv6=off valid=10s;
    client_max_body_size 25M;
    keepalive_timeout 65;
    keepalive_requests 1000;

    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 5;
    gzip_types text/plain text/css application/json application/javascript application/xml+rss image/svg+xml;
    gzip_min_length 512;

    # Bloquear acesso a arquivos ocultos (.env, .git, etc.)
    location ~ /\.{
        deny all;
        access_log off;
        log_not_found off;
    }

    location = /nginx-health {
        access_log off;
        add_header Content-Type text/plain;
        return 200 'ok';
    }

    location = /static/css/ask.css {
        alias /app/staticfiles/css/ask.css;
        access_log off;
        expires -1;
        add_header Cache-Control "no-cache";
    }

    # Assets versionados (hash no nome): cache agressivo com immutable.
    location ^~ /static/react/assets/ {
        alias /app/staticfiles/react/assets/;
        access_log off;
        expires 1y;
        add_header Cache-Control "public, max-age=31536000, immutable";
    }

    location /static/ {
        alias /app/staticfiles/;
        access_log off;
        expires 30d;
        add_header Cache-Control "public, max-age=2592000";
    }

    location /anexos/ {
        alias /app/docs/anexos/;
        access_log off;
        try_files $uri =404;
        expires 7d;
        add_header Cache-Control "public, max-age=604800";
    }

    location /media/ {
        alias /app/media/;
        add_header Cache-Control "public, max-age=86400";
    }

    location /api/ {
        proxy_pass http://app_web/api/;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $proxy_x_forwarded_proto;
        proxy_connect_timeout 5s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_redirect off;
    }

    location = / {
        root /app/docs/anexos;
        try_files /root-signal-core.html =404;
        add_header Cache-Control "no-store";
    }

    # Rotas Django que precisam funcionar na raiz (fora de /manual/)
    location /login/ {
        proxy_pass http://app_web/login/;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $proxy_x_forwarded_proto;
        proxy_connect_timeout 5s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_redirect off;
    }

    location /logout/ {
        proxy_pass http://app_web/logout/;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $proxy_x_forwarded_proto;
        proxy_connect_timeout 5s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_redirect off;
    }

    location /ask/ {
        proxy_pass http://app_web/ask/;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $proxy_x_forwarded_proto;
        proxy_connect_timeout 5s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_redirect off;
    }

    location /inbox/ {
        proxy_pass http://app_web/inbox/;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $proxy_x_forwarded_proto;
        proxy_connect_timeout 5s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_redirect off;
    }

    location /admin/ {
        proxy_pass http://app_web/admin/;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $proxy_x_forwarded_proto;
        proxy_connect_timeout 5s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_redirect off;
    }

    location /password/ {
        proxy_pass http://app_web/password/;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $proxy_x_forwarded_proto;
        proxy_connect_timeout 5s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_redirect off;
    }

    location = /manual {
        return 301 /manual/;
    }

    location /manual/ {
        rewrite ^/manual/(.*)$ /$1 break;
        proxy_pass http://app_web/;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $proxy_x_forwarded_proto;
        proxy_set_header X-Forwarded-Prefix /manual;
        proxy_connect_timeout 5s;
        proxy_send_timeout 60s;
        proxy_redirect off;
        proxy_read_timeout 60s;
    }

    location /financas/ {
        proxy_pass http://app_financas;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $proxy_x_forwarded_proto;
        proxy_connect_timeout 5s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    location = /frases {
        return 301 /frases/;
    }

    location /frases/ {
        proxy_pass http://app_frases/;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host mnrs.com.br;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $proxy_x_forwarded_proto;
        proxy_set_header X-Forwarded-Prefix /frases;
        proxy_connect_timeout 5s;
        proxy_send_timeout 60s;
        proxy_redirect off;
        proxy_read_timeout 60s;
    }

    location /tutoriais/ {
        proxy_pass http://app_tutoriais;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $proxy_x_forwarded_proto;
        proxy_connect_timeout 5s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    location = /treinos {
        proxy_pass http://app_treinos_frontend;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $proxy_x_forwarded_proto;
        proxy_set_header X-Forwarded-Prefix /treinos;
        proxy_connect_timeout 5s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_redirect off;
    }

    location /treinos/api/ {
        rewrite ^/treinos/api/?(.*)$ /api/$1 break;
        proxy_pass http://app_treinos_backend;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $proxy_x_forwarded_proto;
        proxy_set_header X-Forwarded-Prefix /treinos;
        proxy_connect_timeout 5s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_redirect off;
    }

    location /treinos/ {
        proxy_pass http://app_treinos_frontend;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $proxy_x_forwarded_proto;
        proxy_set_header X-Forwarded-Prefix /treinos;
        proxy_connect_timeout 5s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_redirect off;
    }

    # ── Forca (Galgenspiel) ──────────────────────────
    location = /forca {
        return 301 /forca/;
    }

    location /forca/api/ {
        rewrite ^/forca/api/?(.*)$ /api/$1 break;
        proxy_pass http://app_forca_backend;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $proxy_x_forwarded_proto;
        proxy_connect_timeout 5s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
        proxy_redirect off;
    }

    location /forca/ {
        rewrite ^/forca/(.*)$ /$1 break;
        proxy_pass http://app_forca_frontend;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $proxy_x_forwarded_proto;
        proxy_connect_timeout 5s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_redirect off;
    }

    # ── MAPS-SAMU ──
    location = /maps {
        return 301 /maps/;
    }

    location /maps/ {
        rewrite ^/maps/(.*)$ /$1 break;
        proxy_pass http://app_maps_nginx;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $proxy_x_forwarded_proto;
        proxy_connect_timeout 5s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_redirect off;
    }
}
